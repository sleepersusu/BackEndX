<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org/">
<head>
<meta charset="UTF-8" />
<title>會員專區</title>
<link rel="icon" th:href="@{/images/favicon.ico}" />

<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link
	href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@100..900&display=swap"
	rel="stylesheet" />

<link rel="stylesheet"
	href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />

<link rel="stylesheet"
	href="https://cdn.datatables.net/2.1.8/css/dataTables.dataTables.css" />

<link rel="stylesheet" th:href="@{/css/demo.css}" />


<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
	rel="stylesheet"
	integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
	crossorigin="anonymous">

</head>
<body>
	<h2>模擬前端</h2>

	<h4>列出會員所有評論</h4>
	<div class="container">
		<div class="row justify-content-center">


			<table class="table">
				<thead>
					<tr>

						<th scope="col">餐點</th>
						<th scope="col">評論分數</th>
						<th scope="col">你的評論</th>
						<th scope="col">評論時間</th>
						<th>操作</th>
					</tr>
				</thead>
				<tbody>



					<tr th:if="${#lists.isEmpty(allComments)}">
						<td colspan="5">沒有資料</td>
					</tr>

					<tr th:each="comment : ${allComments}" class="fade-out">

						<td th:text="${comment.commentProduct}"></td>
						<td th:text="${comment. commentRating}"></td>
						<td th:text="${comment.commentMessage}"></td>
						<td th:text="${{comment.commentTime}}"></td>
						<td>

							<button id="delete">刪除</button>
						</td>
					</tr>

				</tbody>
			</table>

			<div style="width: 30%; display: block">


				<form th:action="@{/Bistro/postComment}" method="post"
					enctype="multipart/form-data" id="dataForm">


					<div class="question">
						<label for="memberId">會員ID：</label> <input type="text"
							id="memberId" name="memberId" class="form-control" />
					</div>



					<div class="question">
						<label for="categorySelect">餐點分類：</label> <select
							id="categorySelect" name="categorySelect" class="form-select">
							<option value="">請選擇一個分類</option>
						</select>
					</div>


					<div class="question">
						<label for="menuSelect">餐點：</label> <select id="menuSelect"
							name="menuSelect" disabled class="form-select">
							<option value="">請選擇一個餐點</option>
						</select>
					</div>


					<div class="question">
						<label for="commentRating" class="title">評論分數</label> <input
							type="number" id="commentRating" name="commentRating" value=""
							placeholder="1分~5分" required aria-required="true" min="1" max="5"
							class="form-control" />
					</div>

					<div class="question">
						<label for="commentMessage" class="title">評論</label>
						<textarea name="commentMessage" placeholder="" id="commentMessage"
							class="form-control"></textarea>
					</div>

					<!-- 區域1 -->

					<!---------------------------底下為按鈕區---------------------------------------------- -->
					<div id="buttonbox">
						<button type="submit" id="save" class="formbutton"
							onclick="submitForm(event) ">儲存</button>
						<button type="reset" id="reset" class="formbutton"
							onclick="resetPreview()">重設</button>
					</div>
				</form>
			</div>
			<!-- modal-content -->
		</div>
		<!-- addEventModal 跳出表單 -->

	</div>


	<script>
	
function loadCategories() {
  fetch("/api/categories")
    .then((response) => response.json())
    .then((data) => {
      const categorySelect = document.getElementById("categorySelect");
      data.forEach((category) => {
        const option = document.createElement("option");
        option.value = category;
        option.textContent = category;
        categorySelect.appendChild(option);
      });
    })
    .catch((error) => console.error("Error fetching categories:", error));
}

function loadMenusByCategory(category) {
  let menuSelect = document.getElementById("menuSelect");

  if (!category) {
    // 禁用菜品選擇框並重設選項
    menuSelect.innerHTML = '<option value="">請選擇一個菜品</option>';
    menuSelect.disabled = true;
    return;
  }

  // 顯示 Loading 提示並清空選項
  menuSelect.innerHTML = '<option value="">載入中...</option>';
  menuSelect.disabled = true;

  fetch(`/api/menus/${category}`)
    .then((response) => {
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      return response.json();
    })
    .then((data) => {
      menuSelect.innerHTML = '<option value="">請選擇一個菜品</option>'; 
      data.forEach((menu) => {
        const option = document.createElement("option");
        option.dataset.commentProduct = menu.productName; 
        option.value = menu.id; 
        option.textContent = menu.productName; // 顯示菜品名稱
        menuSelect.appendChild(option);
      });
      menuSelect.disabled = false; // 啟用菜品選擇框
    })
    .catch((error) => {
      console.error("Error fetching menus:", error);
      menuSelect.innerHTML =
        '<option value="">載入失敗，請重試</option>'; // 顯示錯誤提示
    });
}

// 初始化頁面
document.addEventListener("DOMContentLoaded", function () {
  loadCategories(); // 載入分類

  const categorySelect = document.getElementById("categorySelect");
  const menuSelect = document.getElementById("menuSelect");

  // 綁定分類選擇事件
  categorySelect.addEventListener("change", function () {
    const category = this.value;
    loadMenusByCategory(category);
  });
});
	



	
 	function submitForm(event) {
    event.preventDefault();  // 防止表單提交刷新頁面

    // 獲取表單數據並組裝為普通的 JavaScript 物件
    const formData = new FormData(document.getElementById('dataForm'));
    const data = {};
    formData.forEach((value, key) => {
        data[key] = value;
    });

    // 發送 POST 請求
  fetch('/Bistro/postComment', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json',  // 设置为 JSON 格式
    },
    body: JSON.stringify(data)  // 将数据转为 JSON 字符串
})
.then(response => response.json())
.then(data => {
    if (data.success) {
        const comment = data.comment;
        const commentRow = `
            <tr>
                <td>${comment.commentProduct}</td>
                <td>${comment.commentRating}</td>
                <td>${comment.commentMessage}</td>
                <td>${comment.commentTime}</td>
                <td>
                    <button type="button" id="delete">刪除</button>
                </td>
            </tr>
        `;
        document.querySelector('tbody').insertAdjacentHTML('beforeend', commentRow);
        document.getElementById('dataForm').reset();
    } else {
        alert('新增評論失敗');
    }
})

}
    
    </script>
</body>
</html>